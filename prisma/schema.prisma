generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                  String             @id @default(cuid())
  login               String             @unique
  passwordHash        String
  role                String             @default("User")
  photo               String?
  twoFactorSecret     String?
  twoFactorEnabled    Boolean            @default(false)
  active              Boolean            @default(true)
  lockedUntil         DateTime?
  failedLoginAttempts Int                @default(0)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  agencyHistory       AgencyHistory[]
  logs                Log[]
  sessions            Session[]
  technicalHistory    TechnicalHistory[]
  createdTasks        Task[]             @relation("TaskCreator")
  closedTasks         Task[]             @relation("TaskCloser")
  alerts              Alert[]
}

model Session {
  id         String   @id @default(cuid())
  token      String   @unique
  userId     String
  expiresAt  DateTime
  lastUsedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Agency {
  id            String          @id @default(cuid())
  name          String
  photo         String?
  state         String          @default("ALERTE")
  validatedAt   DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  codeAgence    String?
  codeRayon     String?
  dateFermeture DateTime?
  dateOuverture DateTime?
  addresses     Address[]
  history       AgencyHistory[]
  contacts      Contact[]
  photos        PhotoGroup[]
  technical     Technical?
  tasks         Task[]
}

model Address {
  id         String   @id @default(cuid())
  agencyId   String
  banId      String?
  label      String
  street     String
  city       String
  postalCode String
  country    String   @default("France")
  latitude   Float?
  longitude  Float?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  agency     Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
}

model Contact {
  id          String   @id @default(cuid())
  agencyId    String
  postNumber  String
  agentNumber String
  directLine  String
  emails      String
  managerName String
  note        String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  agency      Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
}

model Technical {
  id                 String             @id @default(cuid())
  agencyId           String             @unique
  networkIp          String?
  machineBrand       String?
  machineModel       String?
  machineConnection  String?
  machineIp          String?
  machineMac         String?
  wifiRouterBrand    String?
  wifiRouterModel    String?
  wifiRouterIp       String?
  wifiRouterSerial   String?
  mainRouterBrand    String?
  mainRouterModel    String?
  mainRouterIp       String?
  mainRouterSerial   String?
  mainRouterLinkType String?
  backupRouterBrand  String?
  backupRouterModel  String?
  backupRouterIp     String?
  backupRouterSerial String?
  recorderBrand      String?
  recorderModel      String?
  recorderSerial     String?
  recorderMac        String?
  recorderIp         String?
  recorderStorage    String?
  technicalNotes     String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  cameras            Camera[]
  dynamicFields      DynamicField[]
  pcs                PC[]
  printers           Printer[]
  agency             Agency             @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  technicalHistory   TechnicalHistory[]
  wifiAccessPoints   WifiAccessPoint[]
}

model PC {
  id           String    @id @default(cuid())
  technicalId  String
  name         String
  ip           String?
  mac          String?
  serialNumber String?
  brand        String?
  model        String?
  purchaseDate DateTime?
  warrantyDate DateTime?
  files        String?
  photos       String?
  order        Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  technical    Technical @relation(fields: [technicalId], references: [id], onDelete: Cascade)
}

model Printer {
  id           String    @id @default(cuid())
  technicalId  String
  name         String
  ip           String?
  mac          String?
  serialNumber String?
  brand        String?
  model        String?
  purchaseDate DateTime?
  warrantyDate DateTime?
  files        String?
  photos       String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  technical    Technical @relation(fields: [technicalId], references: [id], onDelete: Cascade)
}

model WifiAccessPoint {
  id                String    @id @default(cuid())
  technicalId       String
  brand             String?
  model             String?
  ip                String?
  serialNumber      String?
  ssid              String?
  passwordEncrypted String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  technical         Technical @relation(fields: [technicalId], references: [id], onDelete: Cascade)
}

model Camera {
  id          String    @id @default(cuid())
  technicalId String
  brand       String?
  model       String?
  type        String?
  ip          String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  technical   Technical @relation(fields: [technicalId], references: [id], onDelete: Cascade)
}

model DynamicField {
  id          String    @id @default(cuid())
  technicalId String
  key         String
  value       String
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  technical   Technical @relation(fields: [technicalId], references: [id], onDelete: Cascade)
}

model TechnicalHistory {
  id          String    @id @default(cuid())
  technicalId String
  userId      String
  notes       String?
  version     Int
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id])
  technical   Technical @relation(fields: [technicalId], references: [id], onDelete: Cascade)
}

model PhotoGroup {
  id        String   @id @default(cuid())
  agencyId  String
  type      String
  photos    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  title     String?
  agency    Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
}

model AgencyHistory {
  id        String   @id @default(cuid())
  agencyId  String
  userId    String
  version   Int
  data      String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  agency    Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
}

model Log {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

model Task {
  id          String    @id @default(cuid())
  agencyId    String
  title       String
  createdAt   DateTime  @default(now())
  createdBy   String
  closedAt    DateTime?
  closedBy    String?
  notes       String
  importance  String    @default("INFO") // URGENT, CRITIQUE, INFO
  updatedAt   DateTime  @updatedAt
  agency      Agency    @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  creator     User      @relation("TaskCreator", fields: [createdBy], references: [id])
  closer      User?     @relation("TaskCloser", fields: [closedBy], references: [id])
}

model AppSettings {
  id             String   @id @default("settings")
  sessionTimeout Int      @default(60)
  updatedAt      DateTime @updatedAt
}

model Alert {
  id         String    @id @default(cuid())
  type       String    // FAILED_LOGIN_ATTEMPTS, UNAUTHORIZED_ACCESS, etc.
  severity   String    // low, medium, high, critical
  title      String
  message    String
  details    String?   // JSON
  userId     String?
  ipAddress  String?
  resolved   Boolean   @default(false)
  resolvedAt DateTime?
  resolvedBy String?
  createdAt  DateTime  @default(now())
  user       User?     @relation(fields: [userId], references: [id])
}
